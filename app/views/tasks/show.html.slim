.container.mx-auto.px-4.py-8
  / Breadcrumb
  nav.mb-6.text-sm
    = link_to "â† Back to Projects", projects_path, class: "text-blue-600 hover:text-blue-800"
    - if @task.project
      span.mx-2.text-gray-400 â€º
      = link_to @task.project.name, project_path(@task.project), class: "text-blue-600 hover:text-blue-800"

  / Task Header
  .bg-white.rounded-lg.shadow-lg.overflow-hidden.mb-6
    .bg-gradient-to-r.from-indigo-500.to-purple-600.text-white.p-8
      .flex.justify-between.items-start
        .flex-1
          h1.text-3xl.font-bold.mb-3= @task.title
          .flex.items-center.space-x-4.text-indigo-100
            span.flex.items-center
              svg.w-5.h-5.mr-1 fill="none" stroke="currentColor" viewBox="0 0 24 24"
                path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"
              | Redmine ##{@task.redmine_id}
            span â€¢
            span Created by: #{@task.created_by_name || 'N/A'}
        span.px-4.py-2.rounded-full.text-sm.font-medium class=(@task.status == 'Closed' ? 'bg-green-500' : 'bg-yellow-400 text-gray-800')
          = @task.status

    / Task Stats
    .p-6.bg-gray-50.border-b.border-gray-200
      .grid.grid-cols-2.md:grid-cols-5.gap-4
        .text-center
          .text-2xl.font-bold.text-blue-600= "#{@task.estimated_time || 0}h"
          .text-xs.text-gray-600 Estimated Time
        .text-center
          .text-2xl.font-bold.text-green-600= "#{@task.spent_time || 0}h"
          .text-xs.text-gray-600 Spent Time
        .text-center
          .text-2xl.font-bold.text-purple-600= "#{@task.percent_done || 0}%"
          .text-xs.text-gray-600 Progress
        .text-center
          .text-2xl.font-bold.text-orange-600= @task.test_cases.count
          .text-xs.text-gray-600 Test Cases
        .text-center
          .text-2xl.font-bold.text-indigo-600= @task.subtasks.count
          .text-xs.text-gray-600 Subtasks

    / Task Details
    .p-6
      - if @task.description.present?
        .mb-6
          h2.text-lg.font-semibold.text-gray-800.mb-2 Description
          .bg-gray-50.rounded-lg.p-4
            p.text-gray-700.whitespace-pre-wrap= @task.description

      .grid.grid-cols-1.md:grid-cols-2.gap-6.mb-6
        div
          h3.text-sm.font-semibold.text-gray-600.mb-2 Timeline
          .space-y-2.text-sm
            .flex.justify-between
              span.text-gray-600 Start Date:
              span.font-medium= @task.start_date&.strftime("%Y-%m-%d") || 'N/A'
            .flex.justify-between
              span.text-gray-600 Due Date:
              span.font-medium= @task.due_date&.strftime("%Y-%m-%d") || 'N/A'

        div
          h3.text-sm.font-semibold.text-gray-600.mb-2 Links
          .space-y-2.text-sm
            - if @task.testcase_link.present?
              div
                span.text-gray-600 Testcase:
                a.text-blue-600.hover:underline.ml-2 href=@task.testcase_link target="_blank"
                  | View Sheet â†’
            - if @task.bug_link.present?
              div
                span.text-gray-600 Bug:
                a.text-blue-600.hover:underline.ml-2 href=@task.bug_link target="_blank"
                  | View Link â†’

      - if @task.stg_bugs_vn > 0 || @task.stg_bugs_jp > 0 || @task.prod_bugs > 0
        .mb-6
          h3.text-sm.font-semibold.text-gray-600.mb-2 Bug Statistics
          .flex.space-x-4.text-sm
            .bg-yellow-50.px-4.py-2.rounded-lg
              span.text-gray-600 STG VN:
              span.font-bold.text-yellow-700.ml-1= @task.stg_bugs_vn
            .bg-orange-50.px-4.py-2.rounded-lg
              span.text-gray-600 STG JP:
              span.font-bold.text-orange-700.ml-1= @task.stg_bugs_jp
            .bg-red-50.px-4.py-2.rounded-lg
              span.text-gray-600 Production:
              span.font-bold.text-red-700.ml-1= @task.prod_bugs

  / Subtasks Section
  - if @task.subtasks.any?
    .bg-white.rounded-lg.shadow-lg.p-6.mb-6
      h2.text-2xl.font-bold.text-gray-800.mb-4.flex.items-center
        svg.w-6.h-6.mr-2.text-purple-600 fill="none" stroke="currentColor" viewBox="0 0 24 24"
          path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"
        | Subtasks (#{@task.subtasks.count})

      .grid.grid-cols-1.md:grid-cols-2.lg:grid-cols-3.gap-4
        - @task.subtasks.each do |subtask|
          div data-controller="navigation" data-navigation-url-value=project_task_path(@task.project, subtask)
            .border.border-gray-200.rounded-lg.p-4.hover:border-purple-400.hover:shadow-md.transition-all.cursor-pointer data-action="click->navigation#click"
              .flex.justify-between.items-start.mb-2
                h4.font-medium.text-gray-800.text-sm.line-clamp-2
                  = subtask.title.gsub(@task.title, '').gsub(' - ', '').strip
                span.ml-2.px-2.py-1.text-xs.rounded-full.bg-purple-100.text-purple-700.whitespace-nowrap
                  = "#{subtask.number_of_test_cases} TCs"
              .text-xs.text-gray-500
                | Status: #{subtask.status}

  / Test Cases Section
  - if @task.test_cases.any?
    .bg-white.rounded-lg.shadow-lg.p-6
      h2.text-2xl.font-bold.text-gray-800.mb-4.flex.items-center
        svg.w-6.h-6.mr-2.text-green-600 fill="none" stroke="currentColor" viewBox="0 0 24 24"
          path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
        | Test Cases (#{@task.test_cases.count})

      .space-y-3
        - @task.test_cases.includes(:test_steps).each_with_index do |tc, index|
          .border.border-gray-200.rounded-lg.p-4.hover:border-blue-400.hover:bg-blue-50.transition-all
            .flex.justify-between.items-start.mb-3
              .flex-1
                h4.font-semibold.text-gray-800.text-lg.mb-1
                  = "#{index + 1}. #{tc.title}"
                - if tc.function.present?
                  p.text-sm.text-gray-600.mb-2
                    strong Function:
                    = " #{tc.function}"
              .flex.flex-col.items-end.space-y-1
                span.px-3.py-1.text-xs.rounded-full.font-medium class=(tc.test_type == 'feature' ? 'bg-blue-100 text-blue-700' : tc.test_type == 'ui' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700')
                  = tc.test_type.upcase
                span.text-xs.text-gray-500
                  = tc.target_display

            / Device Test Results
            - if tc.has_device_results?
              .mb-3.pb-3.border-b.border-gray-200
                .text-xs.font-semibold.text-gray-600.mb-2 ðŸ“± Device Test Results:
                .flex.flex-wrap.gap-2
                  - tc.parsed_device_results.each do |result|
                    - device_name = result[:device].to_s.split(' ').first
                    - status_class = case result[:status].to_s
                    - when 'pass' then 'bg-green-500 text-white border-green-600'
                    - when 'fail', 'failed' then 'bg-red-500 text-white border-red-600'
                    - when 'not_run' then 'bg-gray-400 text-white border-gray-500'
                    - when 'blocked' then 'bg-yellow-500 text-white border-yellow-600'
                    - else 'bg-gray-400 text-white border-gray-500'
                    - icon = case result[:status].to_s
                    - when 'pass' then 'âœ“'
                    - when 'fail', 'failed' then 'âœ—'
                    - when 'not_run' then 'â—‹'
                    - when 'blocked' then 'â–³'
                    - else '?'
                    span.inline-flex.items-center.px-3.py-1\.5.rounded-lg.text-sm.font-semibold.border-2 class=status_class title="#{result[:device]} - #{result[:status].upcase}"
                      span.mr-1\.5= icon
                      span= device_name

            / Test Steps
            - if tc.test_steps.any?
              .border-t.border-gray-200.pt-3.mt-3
                .text-sm.font-semibold.text-gray-700.mb-2
                  | Test Steps (#{tc.test_steps.count})
                - tc.test_steps.ordered.each_with_index do |step, step_idx|
                  .mb-4.pl-4.border-l-2.border-blue-200
                    .font-medium.text-gray-700.mb-2 Step #{step.step_number}

                    - if step.action_contents.any?
                      .mb-2
                        .text-xs.font-semibold.text-gray-600.mb-1 Actions:
                        ul.list-disc.list-inside.text-sm.text-gray-600.space-y-1.ml-2
                          - step.action_contents.each do |content|
                            li.text-xs.leading-relaxed= content.content_value

                    - if step.expected_contents.any?
                      div
                        .text-xs.font-semibold.text-green-700.mb-1 Expected Results:
                        ul.list-disc.list-inside.text-sm.text-gray-600.space-y-1.ml-2
                          - step.expected_contents.each do |content|
                            li.text-xs.leading-relaxed.text-green-700= content.content_value
            - else
              p.text-sm.text-gray-500.italic No test steps defined
  - else
    .bg-white.rounded-lg.shadow-lg.p-8.text-center
      .text-gray-400.text-4xl.mb-4 ðŸ“‹
      h3.text-xl.font-semibold.text-gray-700.mb-2 No Test Cases
      p.text-gray-500 This task doesn't have any test cases yet.


